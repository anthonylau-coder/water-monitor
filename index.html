<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>智能水位監控 - V13 Firebase 實作版</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: #fff; margin: 0; padding: 15px; transition: background 0.8s; }
        .status-bar { padding: 10px; font-size: 14px; text-align: center; margin-bottom: 15px; border-radius: 8px; font-weight: bold; border: 1px solid transparent; }
        .online { background: rgba(0, 68, 0, 0.8); color: #00ff00; border-color: #00ff00; }
        .offline { background: rgba(68, 0, 0, 0.8); color: #ff0000; border-color: #ff0000; }
        .main-display { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .label { font-size: 12px; color: #888; letter-spacing: 1px; }
        .value { font-size: 80px; font-weight: bold; color: #00ff00; transform: scale(0.9, 1); transform-origin: left; line-height: 1; }
        .unit { font-size: 24px; color: #00ff00; margin-left: 5px; }
        .temp-val { font-size: 30px; font-weight: bold; color: #00ffff; }
        .temp-unit { font-size: 16px; color: #00ffff; margin-left: 5px; }
        .sub-data { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 10px; }
        #alarm-box { display: none; padding: 15px; margin: 10px 0; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .chart-section { background: #111; padding: 10px; border-radius: 10px; height: 230px; }
    </style>
</head>
<body>

    <div id="status" class="status-bar offline">雲端初始化中...</div>
    <div id="alarm-box"></div>

    <div class="main-display">
        <div class="label">WATER LEVEL</div>
        <div class="value-row" style="display:flex; align-items:baseline;">
            <div id="level" class="value">0</div>
            <div class="unit">mm</div>
        </div>
        
        <div class="label" style="margin-top:10px;">TEMPERATURE</div>
        <div style="display:flex; align-items:baseline;">
            <div id="temp" class="temp-val">--.-</div>
            <div class="temp-unit">°C</div>
        </div>

        <div class="sub-data">
            <div id="full_date" style="width: 100%; color: #aaa; margin-bottom: 5px;">更新時間: 讀取雲端中...</div>
            <span>訊號: <span id="sig_display">--</span> dBm</span>
            <span>電壓: <span id="vol_display" style="font-weight:bold;">--</span> V</span>
        </div>
    </div>

    <div class="chart-section"><canvas id="waterChart"></canvas></div>

    <script>
        // 使用你提供的專屬配置
        const firebaseConfig = {
            apiKey: "AIzaSyBAzQFLLDACisyZN6CEIFunkA2by0LzocE",
            authDomain: "water-monitor-system-cbccd.firebaseapp.com",
            databaseURL: "https://water-monitor-system-cbccd-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "water-monitor-system-cbccd",
            storageBucket: "water-monitor-system-cbccd.firebasestorage.app",
            messagingSenderId: "924884619328",
            appId: "1:924884619328:web:0e187dd574cd54ee4e8fa5"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // MQTT 配置
        const MQTT_CONFIG = { host: 'af11f11a.ala.asia-southeast1.emqxsl.com', port: 8084, user: 'test', pass: 'test1234', topic: '/outerAccess/subWaterLevelTopic' };
        
        let waterConfirmCount = 0, volConfirmCount = 0, currentLevel = 0, currentVolAlarm = false;

        // 初始化圖表
        const ctx = document.getElementById('waterChart').getContext('2d');
        const waterChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#00ff00', backgroundColor: 'rgba(0, 255, 0, 0.1)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 2 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#444', font: {size: 9} } }, y: { beginAtZero: true, ticks: { color: '#444' } } } }
        });

        // 從 Firebase 加載數據
        function initFromFirebase() {
            // 讀取最後一筆狀態
            db.ref('latest_status').once('value', (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    updateUI(val.level, val.temp, val.sig, val.vol, val.time, false);
                }
            });
            
            // 讀取最近歷史記錄填入圖表
            db.ref('history').limitToLast(30).once('value', (snapshot) => {
                waterChart.data.labels = [];
                waterChart.data.datasets[0].data = [];
                snapshot.forEach((child) => {
                    const d = child.val();
                    const shortTime = d.time.includes(' ') ? d.time.split(' ')[1] : d.time;
                    waterChart.data.labels.push(shortTime);
                    waterChart.data.datasets[0].data.push(d.level);
                });
                waterChart.update();
            });
        }
        initFromFirebase();

        // MQTT 連線
        const client = mqtt.connect(`wss://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}/mqtt`, {
    // 每次生成隨機 ID，防止沈工喺電腦同手機同時打開網頁時「互相踢下線」
    clientId: 'WEB_USER_' + Math.random().toString(16).slice(2, 8), 
    username: MQTT_CONFIG.user,
    password: MQTT_CONFIG.pass,
    
    keepalive: 60,         // 心跳由 30s 加長到 60s，增加對弱網環境嘅容忍度
    reconnectPeriod: 2000, // 如果斷咗，每 2 秒自動試一次重連
    connectTimeout: 30000, // 30 秒連唔到先當逾時
    clean: true            // 每次連線都係乾淨新開始
});

        client.on('connect', () => {
            document.getElementById('status').innerText = "● 雲端連線成功 (Firebase Sync)";
            document.getElementById('status').className = "status-bar online";
            client.subscribe(MQTT_CONFIG.topic);
        });

        client.on('message', (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                const now = new Date();
                const timeStr = now.toLocaleDateString('zh-HK') + " " + now.toLocaleTimeString('zh-HK', { hour12: false });
                
                const mm = Math.round(parseFloat(data.waterLevel) * 1000);
                const temp = parseFloat(data.waterTemperature || 0).toFixed(1);
                const vol = parseFloat(data.sensorVoltage || 0).toFixed(2);
                const sig = data.signalStrength || "--";

                updateUI(mm, temp, sig, vol, timeStr, true);

            } catch (e) { console.error(e); }
        });

        function updateUI(level, temp, sig, vol, time, shouldSave) {
            document.getElementById('level').innerText = level;
            document.getElementById('temp').innerText = temp;
            document.getElementById('sig_display').innerText = sig;
            document.getElementById('vol_display').innerText = vol;
            document.getElementById('full_date').innerText = "更新時間: " + time;

            if (shouldSave) {
                const shortTime = time.includes(' ') ? time.split(' ')[1] : time;
                waterChart.data.labels.push(shortTime);
                waterChart.data.datasets[0].data.push(level);
                if (waterChart.data.labels.length > 100) { waterChart.data.labels.shift(); waterChart.data.datasets[0].data.shift(); }
                waterChart.update();

                // 同步至 Firebase
                const entry = { level, temp, sig, vol, time };
                db.ref('latest_status').set(entry);
                db.ref('history').push(entry);
            }

            updateWaterLogic(level);
            updateVolLogic(parseFloat(vol));
            renderAlarmUI();
        }

        function updateWaterLogic(val) {
            let lv = (val >= 300) ? 3 : (val >= 120 ? 2 : (val >= 70 ? 1 : 0));
            if (lv > 0) waterConfirmCount++; else waterConfirmCount = 0;
            currentLevel = (waterConfirmCount >= 2) ? lv : 0;
        }

        function updateVolLogic(vol) {
            if (vol > 0 && vol < 3.4) volConfirmCount++; else volConfirmCount = 0;
            currentVolAlarm = (volConfirmCount >= 2);
            document.getElementById('vol_display').style.color = currentVolAlarm ? "#ff0" : "#666";
        }

        function renderAlarmUI() {
            const box = document.getElementById('alarm-box');
            if (currentLevel > 0) {
                box.style.display = "block";
                const colors = ["", "#443300", "#663300", "#660000"];
                box.innerText = "【警告】水位異常 Lv." + currentLevel;
                document.body.style.background = colors[currentLevel];
            } else if (currentVolAlarm) {
                box.style.display = "block"; box.innerText = "【注意】設備電池電量低";
                box.style.background = "#555500"; document.body.style.background = "#333300";
            } else {
                box.style.display = "none"; document.body.style.background = "#000";
            }
        }
    </script>
</body>
</html>