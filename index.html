<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>水位監控 - 專業 DEMO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        body { 
            font-family: 'Courier New', Courier, monospace; 
            background: #000; 
            color: #fff; 
            margin: 0; 
            padding: 10px; 
            transition: background 0.1s; 
        }

        /* 回歸舊版狀態條：有背景色同文字 */
        .status-bar { 
            padding: 10px; 
            font-size: 14px; 
            text-align: center; 
            margin-bottom: 20px; 
            border-radius: 4px; 
            font-weight: bold;
        }
        .online { background: #004400; color: #00ff00; border: 1px solid #00ff00; }
        .offline { background: #440000; color: #ff0000; border: 1px solid #ff0000; }

        .data-item { 
            position: relative; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #222; 
            padding-bottom: 15px; 
        }

        .label { 
            font-size: 14px; 
            color: #888; 
            font-weight: bold; 
        }

        .value-row { 
            display: flex; 
            align-items: baseline; 
            gap: 8px; 
            margin-top: 5px; 
        }

        /* 數字繼續保持壓扁比例 (0.85 寬 / 0.75 高) */
        .value { 
            font-size: 80px; 
            font-weight: bold; 
            color: #00ff00; 
            line-height: 1; 
            text-shadow: 0 0 10px rgba(0,255,0,0.2);
            display: inline-block;
            transform: scale(0.85, 0.75); 
            transform-origin: left bottom; 
            white-space: nowrap;
        }

        .unit { 
            font-size: 20px; 
            color: #00ff00; 
            display: inline-block;
            transform: scaleY(0.8);
            margin-left: -10px;
        }

        /* Update 顯示在數據項右下角 */
        .time { 
            display: block;
            font-size: 11px; 
            color: #444; 
            margin-top: -10px;
            font-style: normal;
        }
    </style>
</head>
<body>

    <div id="status" class="status-bar offline">等待連線...</div>

    <div class="container">
        <div class="data-item">
            <div class="label">WATER LEVEL</div>
            <div class="value-row">
                <div id="level" class="value">0</div>
                <div class="unit">mm</div>
            </div>
            <div id="time_level" class="time">Update: ----/--/-- --:--:--</div>
        </div>

        <div class="data-item">
            <div class="label">TEMPERATURE</div>
            <div class="value-row">
                <div id="temp" class="value">00.0</div>
                <div class="unit">°C</div>
            </div>
            <div id="time_temp" class="time">Update: ----/--/-- --:--:--</div>
        </div>

        <div class="data-item">
            <div class="label">4G SIGNAL</div>
            <div class="value-row">
                <div id="signal" class="value">--</div>
                <div class="unit">dBm</div>
            </div>
            <div id="time_sig" class="time">Update: ----/--/-- --:--:--</div>
        </div>

        <div class="data-item" style="border-bottom: none;">
            <div class="label">SENSOR VOLTAGE</div>
            <div class="value-row">
                <div id="voltage" class="value">0.00</div>
                <div class="unit">V</div>
            </div>
            <div id="time_vol" class="time">Update: ----/--/-- --:--:--</div>
        </div>
    </div>

    <script>
        const config = {
            host: 'af11f11a.ala.asia-southeast1.emqxsl.com', 
            port: 8084, 
            user: 'test', 
            pass: 'test1234' 
        };

        // 已取消 onclick 全屏切換功能

        const client = mqtt.connect(`wss://${config.host}:${config.port}/mqtt`, {
            clientId: 'Monitor_Final_V5_' + Math.random().toString(16).slice(2, 8),
            username: config.user,
            password: config.pass,
            protocolVersion: 4
        });

        client.on('connect', () => {
            document.getElementById('status').innerText = "● 系統在線 | 正在監控數據";
            document.getElementById('status').className = "status-bar online";
            client.subscribe("/outerAccess/subWaterLevelTopic");
        });

        client.on('message', (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const time = now.toLocaleTimeString('zh-HK', { hour12: false });
                const fullUpdateStr = `Update: ${year}-${month}-${day} ${time}`;

                if(data.waterLevel !== undefined) {
                    const mmValue = Math.round(parseFloat(data.waterLevel) * 1000);
                    document.getElementById('level').innerText = mmValue; 
                }
                
                if(data.waterTemperature !== undefined) document.getElementById('temp').innerText = data.waterTemperature;
                if(data.signalStrength !== undefined) document.getElementById('signal').innerText = data.signalStrength;
                if(data.sensorVoltage !== undefined) document.getElementById('voltage').innerText = data.sensorVoltage;

                document.getElementById('time_level').innerText = fullUpdateStr;
                document.getElementById('time_temp').innerText = fullUpdateStr;
                document.getElementById('time_sig').innerText = fullUpdateStr;
                document.getElementById('time_vol').innerText = fullUpdateStr;

                document.body.style.background = "#0a2a0a"; 
                setTimeout(() => { document.body.style.background = "#000"; }, 100);

                client.publish(`/outerAccess/pubWaterLevelTopic/${data.deviceCode}`, JSON.stringify({
                    "msg": "接收消息成功",
                    "collectionTime": data.collectionTime,
                    "code": 200,
                    "deviceCode": data.deviceCode
                }));
            } catch (e) { console.error(e); }
        });

        client.on('offline', () => { 
            document.getElementById('status').innerText = "● 連線中斷";
            document.getElementById('status').className = "status-bar offline"; 
        });
    </script>
</body>
</html>