<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>智能水位監控系統 - V9 全數據版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: #000; color: #fff; margin: 0; padding: 15px; transition: background 0.8s; }
        .status-bar { padding: 10px; font-size: 14px; text-align: center; margin-bottom: 15px; border-radius: 8px; font-weight: bold; border: 1px solid transparent; }
        .online { background: rgba(0, 68, 0, 0.8); color: #00ff00; border-color: #00ff00; }
        .offline { background: rgba(68, 0, 0, 0.8); color: #ff0000; border-color: #ff0000; }
        
        /* 數值區間 */
        .main-display { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .label { font-size: 12px; color: #888; letter-spacing: 1px; }
        .value-row { display: flex; align-items: baseline; }
        .value { font-size: 80px; font-weight: bold; color: #00ff00; transform: scale(0.9, 1); transform-origin: left; line-height: 1; }
        .unit { font-size: 24px; color: #00ff00; margin-left: 5px; }
        
        .secondary-display { display: flex; gap: 30px; margin-top: 5px; padding-bottom: 10px; border-bottom: 2px solid #222; }
        .temp-val { font-size: 30px; font-weight: bold; color: #00ffff; }
        .temp-unit { font-size: 16px; color: #00ffff; }

        .sub-data { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 10px; }
        
        #alarm-box { display: none; padding: 15px; margin: 15px 0; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; box-shadow: 0 0 20px rgba(0,0,0,0.5); animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .chart-section { background: #111; padding: 10px; border-radius: 10px; margin-top: 15px; height: 250px; }
    </style>
</head>
<body>

    <div id="status" class="status-bar offline">系統初始化中...</div>
    <div id="alarm-box"></div>

    <div class="main-display">
        <div class="label">WATER LEVEL</div>
        <div class="value-row">
            <div id="level" class="value">0</div>
            <div class="unit">mm</div>
        </div>
        
        <div class="label" style="margin-top:10px;">TEMPERATURE</div>
        <div class="value-row">
            <div id="temp" class="temp-val">--.-</div>
            <div class="temp-unit">°C</div>
        </div>

        <div class="sub-data">
            <span id="time_level">更新: --:--:--</span>
            <span>訊號: <span id="sig_display">--</span> dBm | 電壓: <span id="vol_display">--</span> V</span>
        </div>
    </div>

    <div class="chart-section">
        <canvas id="waterChart"></canvas>
    </div>

    <script>
        const MQTT_CONFIG = { host: 'af11f11a.ala.asia-southeast1.emqxsl.com', port: 8084, user: 'test', pass: 'test1234', topic: '/outerAccess/subWaterLevelTopic' };
        let alarmConfirmCount = 0;

        const ctx = document.getElementById('waterChart').getContext('2d');
        const waterChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#00ff00', backgroundColor: 'rgba(0, 255, 0, 0.1)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 3 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#444', font: {size: 10} } }, y: { beginAtZero: true, ticks: { color: '#444' }, grid: { color: '#222' } } } }
        });

        const client = mqtt.connect(`wss://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}/mqtt`, { clientId: 'WEB_V9_' + Math.random().toString(16).slice(2, 8), username: MQTT_CONFIG.user, password: MQTT_CONFIG.pass });

        client.on('connect', () => {
            document.getElementById('status').innerText = "● 系統在線 (加密連線中)";
            document.getElementById('status').className = "status-bar online";
            client.subscribe(MQTT_CONFIG.topic);
        });

        client.on('message', (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                const timeStr = new Date().toLocaleTimeString('zh-HK', { hour12: false });

                // 1. 水位與圖表
                if (data.waterLevel !== undefined) {
                    const mm = Math.round(parseFloat(data.waterLevel) * 1000);
                    document.getElementById('level').innerText = mm;
                    document.getElementById('time_level').innerText = `更新: ${timeStr}`;
                    
                    waterChart.data.labels.push(timeStr);
                    waterChart.data.datasets[0].data.push(mm);
                    if (waterChart.data.labels.length > 100) { waterChart.data.labels.shift(); waterChart.data.datasets[0].data.shift(); }
                    waterChart.update();
                    checkAlarmLogic(mm);
                }

                // 2. 溫度顯示
                if (data.waterTemperature !== undefined) {
                    document.getElementById('temp').innerText = parseFloat(data.waterTemperature).toFixed(1);
                }

                // 3. 訊號與電壓
                if (data.signalStrength !== undefined) document.getElementById('sig_display').innerText = data.signalStrength;
                if (data.sensorVoltage !== undefined) document.getElementById('vol_display').innerText = data.sensorVoltage;

            } catch (e) { console.error(e); }
        });

        function checkAlarmLogic(val) {
            const box = document.getElementById('alarm-box');
            let currentLv = 0;
            if (val >= 300) currentLv = 3;
            else if (val >= 120) currentLv = 2;
            else if (val >= 70) currentLv = 1;

            if (currentLv > 0) {
                alarmConfirmCount++;
            } else {
                alarmConfirmCount = 0;
                box.style.display = "none";
                document.body.style.background = "#000";
                return;
            }

            if (alarmConfirmCount >= 2) {
                box.style.display = "block";
                if (currentLv === 1) { box.innerText = "【警告】水位達 70mm (Lv.1)"; document.body.style.background = "#443300"; }
                if (currentLv === 2) { box.innerText = "【嚴重】水位達 120mm (Lv.2)"; document.body.style.background = "#663300"; }
                if (currentLv === 3) { box.innerText = "【危險】水位超過 300mm (Lv.3)"; document.body.style.background = "#660000"; }
            }
        }
    </script>
</body>
</html>