<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>智能水位監控 - Firebase 顯示版</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: #fff; margin: 0; padding: 15px; transition: background 0.8s; }
        .status-bar { padding: 10px; font-size: 14px; text-align: center; margin-bottom: 15px; border-radius: 8px; font-weight: bold; border: 1px solid transparent; }
        .online { background: rgba(0, 68, 0, 0.8); color: #00ff00; border-color: #00ff00; }
        .offline { background: rgba(68, 0, 0, 0.8); color: #ff0000; border-color: #ff0000; }
        .main-display { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .label { font-size: 12px; color: #888; letter-spacing: 1px; }
        .value { font-size: 80px; font-weight: bold; color: #00ff00; transform: scale(0.9, 1); transform-origin: left; line-height: 1; }
        .unit { font-size: 24px; color: #00ff00; margin-left: 5px; }
        .temp-val { font-size: 30px; font-weight: bold; color: #00ffff; }
        .temp-unit { font-size: 16px; color: #00ffff; margin-left: 5px; }
        .sub-data { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 10px; }
        #alarm-box { display: none; padding: 15px; margin: 10px 0; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .chart-section { background: #111; padding: 10px; border-radius: 10px; height: 230px; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .last-update { font-size: 11px; color: #444; text-align: right; margin-top: 5px; }
        .data-source { font-size: 10px; color: #333; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="status" class="status-bar offline">連線至 Firebase...</div>
    <div id="alarm-box"></div>

    <div class="main-display">
        <div class="label">WATER LEVEL</div>
        <div class="value-row" style="display:flex; align-items:baseline;">
            <div id="level" class="value">--</div>
            <div class="unit">mm</div>
        </div>
        
        <div class="label" style="margin-top:10px;">TEMPERATURE</div>
        <div style="display:flex; align-items:baseline;">
            <div id="temp" class="temp-val">--.-</div>
            <div class="temp-unit">°C</div>
        </div>

        <div class="sub-data">
            <div id="full_date" style="width: 100%; color: #aaa; margin-bottom: 5px;">更新時間: 讀取雲端中...</div>
            <span>訊號: <span id="sig_display">--</span> dBm</span>
            <span>電壓: <span id="vol_display" style="font-weight:bold;">--</span> V</span>
        </div>
    </div>

    <div class="chart-section">
        <canvas id="waterChart"></canvas>
    </div>
    
    <div class="last-update" id="lastUpdateTime"></div>
    <div class="data-source">資料來源: Firebase 即時資料庫</div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAzQFLLDACisyZN6CEIFunkA2by0LzocE",
            authDomain: "water-monitor-system-cbccd.firebaseapp.com",
            databaseURL: "https://water-monitor-system-cbccd-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "water-monitor-system-cbccd",
            storageBucket: "water-monitor-system-cbccd.firebasestorage.app",
            messagingSenderId: "924884619328",
            appId: "1:924884619328:web:0e187dd574cd54ee4e8fa5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // Global variables
        let currentLevel = 0;
        let currentVolAlarm = false;
        let historyData = [];
        let chartInitialized = false;
        
        // Chart initialization
        const ctx = document.getElementById('waterChart').getContext('2d');
        const waterChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [{ 
                    data: [], 
                    borderColor: '#00ff00', 
                    backgroundColor: 'rgba(0, 255, 0, 0.1)', 
                    borderWidth: 2, 
                    fill: true, 
                    tension: 0.3, 
                    pointRadius: 2 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false } 
                }, 
                scales: { 
                    x: { 
                        ticks: { color: '#444', font: {size: 9} },
                        grid: { color: '#222' }
                    }, 
                    y: { 
                        beginAtZero: true, 
                        ticks: { color: '#444' },
                        grid: { color: '#222' }
                    } 
                } 
            }
        });

        // ==================== FIREBASE DATA LISTENERS ====================

        // Listen for latest status changes
        function setupFirebaseListeners() {
            // Update connection status
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    document.getElementById('status').innerText = "● 已連接至 Firebase";
                    document.getElementById('status').className = "status-bar online";
                } else {
                    document.getElementById('status').innerText = "○  Firebase 離線";
                    document.getElementById('status').className = "status-bar offline";
                }
            });

            // Listen for latest status
            const latestStatusRef = db.ref('latest_status');
            latestStatusRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateUIFromFirebase(data);
                    updateAlarmLogic(data);
                } else {
                    console.log('No latest status data available');
                    document.getElementById('level').innerText = '--';
                    document.getElementById('temp').innerText = '--.-';
                }
            }, (error) => {
                console.error('Error reading latest status:', error);
                document.getElementById('status').innerText = "Firebase 讀取錯誤";
            });

            // Listen for history data (last 30 entries)
            const historyRef = db.ref('history').orderByKey().limitToLast(30);
            historyRef.on('value', (snapshot) => {
                const history = [];
                const labels = [];
                const values = [];
                
                snapshot.forEach((child) => {
                    const data = child.val();
                    history.push(data);
                    
                    // Format time for chart
                    let timeLabel = '';
                    if (data.collectionTime) {
                        const timeParts = data.collectionTime.split(' ');
                        timeLabel = timeParts.length > 1 ? timeParts[1].substring(0, 5) : data.collectionTime.substring(0, 5);
                    } else if (data.time) {
                        const timeParts = data.time.split(' ');
                        timeLabel = timeParts.length > 1 ? timeParts[1].substring(0, 5) : data.time.substring(0, 5);
                    } else {
                        timeLabel = '--:--';
                    }
                    
                    labels.push(timeLabel);
                    
                    // Get level value
                    let levelValue = data.level || data.waterLevel_mm || 0;
                    if (data.waterLevel && !levelValue) {
                        levelValue = Math.round(parseFloat(data.waterLevel) * 1000);
                    }
                    values.push(levelValue);
                });
                
                // Update chart
                updateChart(labels, values);
                
            }, (error) => {
                console.error('Error reading history:', error);
            });
        }

        // Update UI with Firebase data
        function updateUIFromFirebase(data) {
            // Extract values with proper defaults
            const level = data.level || data.waterLevel_mm || 0;
            const temp = data.temp || data.waterTemperature || '--.-';
            const sig = data.sig || data.signalStrength || '--';
            const vol = data.vol || data.sensorVoltage || '--';
            const time = data.time || data.collectionTime || getCurrentTimeString();
            
            // Update display
            document.getElementById('level').innerText = level;
            document.getElementById('temp').innerText = temp;
            document.getElementById('sig_display').innerText = sig;
            document.getElementById('vol_display').innerText = vol;
            document.getElementById('full_date').innerText = "更新時間: " + time;
            
            // Update last update time
            document.getElementById('lastUpdateTime').innerText = "最後更新: " + new Date().toLocaleString('zh-HK');
        }

        // Update alarm logic based on Firebase data
        function updateAlarmLogic(data) {
            // Update water level alarm
            const level = parseInt(data.level || data.waterLevel_mm || 0);
            currentLevel = (level >= 300) ? 3 : (level >= 120 ? 2 : (level >= 70 ? 1 : 0));
            
            // Update voltage alarm
            const voltage = parseFloat(data.vol || data.sensorVoltage || 5);
            currentVolAlarm = (voltage > 0 && voltage < 3.4);
            
            // Render alarm UI
            renderAlarmUI();
        }

        // Update chart with new data
        function updateChart(labels, values) {
            waterChart.data.labels = labels;
            waterChart.data.datasets[0].data = values;
            waterChart.update('none');
        }

        // Render alarm box based on current state
        function renderAlarmUI() {
            const box = document.getElementById('alarm-box');
            
            if (currentLevel > 0) {
                box.style.display = "block";
                const colors = ["", "#443300", "#d35400", "#660000"];
                const messages = ["", "低水位警告 Lv.1", "中水位警告 Lv.2", "高水位警告 Lv.3"];
                box.innerText = "【注意】" + messages[currentLevel];
                box.style.background = colors[currentLevel];
                document.body.style.background = colors[currentLevel];
            } else if (currentVolAlarm) {
                box.style.display = "block"; 
                box.innerText = "【注意】設備電池電量低";
                box.style.background = "#555500"; 
                document.body.style.background = "#333300";
            } else {
                box.style.display = "none"; 
                document.body.style.background = "#000";
            }
        }

        // Helper function to get current time string
        function getCurrentTimeString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Initialize data from Firebase once (for immediate display)
        function initializeFromFirebase() {
            db.ref('latest_status').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateUIFromFirebase(data);
                    updateAlarmLogic(data);
                }
            }).catch(error => {
                console.error('Error initializing from Firebase:', error);
            });
        }

        // ==================== INITIALIZATION ====================

        // Start the application
        function init() {
            console.log('Initializing Firebase display...');
            initializeFromFirebase();
            setupFirebaseListeners();
        }

        // Run initialization when page loads
        window.addEventListener('load', init);

        // Optional: Add manual refresh button functionality
        function refreshData() {
            initializeFromFirebase();
        }

    </script>
</body>
</html>
